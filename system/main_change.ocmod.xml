<?xml version="1.0" encoding="utf-8"?>
<modification>
  <name>Main modification for shop</name>
  <code>default</code>
  <version>1.0</version>
  <author>Lugano</author>
  <link></link>
  <file path="system/engine/action.php">
      <operation>
	 <search regex ="true" quote = "true">
  <![CDATA[~public function __construct($route, $args = array()) {
		$parts = explode('/', str_replace('../', '', (string)$route));

		// Break apart the route
		while ($parts) {
			$file = DIR_APPLICATION . 'controller/' . implode('/', $parts) . '.php';

			if (is_file($file)) {
				$this->file = $file;

				$this->class = 'Controller' . preg_replace('/[^a-zA-Z0-9]/', '', implode('/', $parts));
				break;
			} else {
				$this->method = array_pop($parts);
			}
		}

		if (!$this->method) {
			$this->method = 'index';
		}

		$this->args = $args;
	}~]]>	
     </search>
     <add position ="replace"><![CDATA[
public function __construct($route, $args = array()) {
                    
                static $recursion = TRUE;
              
		$parts = explode('/', str_replace('../', '', (string)$route));

		// Break apart the route
		while ($parts) {
                    
                        if ($recursion) {
                    
                             $file = DIR_APPLICATION . 'controller/' . implode('/', $parts) . '.php';
                        } else {
                            
                             $file = $_SERVER['DOCUMENT_ROOT'] . '/admin/controller/' . implode('/', $parts) . '.php';
                        }
			

			if (is_file($file)) {
				$this->file = $file;

				$this->class = 'Controller' . preg_replace('/[^a-zA-Z0-9]/', '', implode('/', $parts));
				break;
			} else {
				$this->method = array_pop($parts);
			}
		}

		if (!$this->method) {
			$this->method = 'index';
		}
                
                if (empty($this->file) || empty($this->class) || empty($this->method)) {
                    
                    if ($recursion) {
                       $recursion = FALSE;
                       Action::__construct($route, $args);  
                    }
                   
                   
                }

		$this->args = $args;
	}]]>

                               
       </add>
    </operation>
  </file>
  <file path="catalog/controller/account/newsletter.php">
      <operation>
	 <search regex ="true" quote = "true">
         <![CDATA[~if (!$this->customer->isLogged()) {
			$this->session->data['redirect'] = $this->url->link('account/newsletter', '', 'SSL');

			$this->response->redirect($this->url->link('account/login', '', 'SSL'));
		}~]]>   
         </search> 
         <add position ="replace">
         <![CDATA[ $this->session->data['redirect'] = $this->url->link('account/newsletter', '', 'SSL');]]> 
         </add>
    </operation>
  </file>
  <file path="catalog/controller/common/footer.php">
      <operation>
	 <search regex ="true" quote = "true">
         <![CDATA[~foreach ($this->model_catalog_information->getInformations() as $result) {
			if ($result['bottom']) {
				$data['informations'][] = array(
					'title' => $result['title'],
					'href'  => $this->url->link('information/information', 'information_id=' . $result['information_id'])
				);
			}
		}~]]>
         </search> 
         <add position ="replace">
         <![CDATA[foreach ($this->model_catalog_information->getInformations() as $result) {
			if ($result['bottom']) {
				$data['informations'][$result['title']] = array(
					'title' => $result['title'],
					'href'  => $this->url->link('information/information', 'information_id=' . $result['information_id'])
				);
			}
		}]]>
       </add>
    </operation>
  </file>
  <file path="catalog/controller/module/filter.php">
      <operation>
	 <search>
             <![CDATA[$data['action'] = str_replace('&amp;', '&', $this->url->link('product/category', 'path=' . $this->request->get['path'] . $url));]]>
         </search>
         <add position ="after">
             <![CDATA[$this->document->addScript('catalog/view/javascript/customer-filter.js');]]>
         </add>  
      </operation>
  </file>
   <file path="catalog/controller/common/footer.php">
      <operation>
	 <search>
             <![CDATA[$data['text_newsletter'] = $this->language->get('text_newsletter');]]>
         </search>
         <add position ="after">
         <![CDATA[$data['telephone'] = $this->config->get('config_telephone');
                // Menu
		$this->load->model('catalog/category');

		$this->load->model('catalog/product');

		$data['categories'] = array();

		$categories = $this->model_catalog_category->getCategories(0);

		foreach ($categories as $category) {
			if ($category['top']) {
				// Level 2
				$children_data = array();

				$children = $this->model_catalog_category->getCategories($category['category_id']);

				foreach ($children as $child) {
					$filter_data = array(
						'filter_category_id'  => $child['category_id'],
						'filter_sub_category' => true
					);

					$children_data[] = array(
						'name'  => $child['name'] . ($this->config->get('config_product_count') ? ' (' . $this->model_catalog_product->getTotalProducts($filter_data) . ')' : ''),
						'href'  => $this->url->link('product/category', 'path=' . $category['category_id'] . '_' . $child['category_id'])
					);
				}

				// Level 1
				$data['categories'][] = array(
					'name'     => $category['name'],
					'children' => $children_data,
					'column'   => $category['column'] ? $category['column'] : 1,
					'href'     => $this->url->link('product/category', 'path=' . $category['category_id'])
				);
			}
		}]]>
         </add>  
      </operation>
  </file>
   <file path="catalog/model/design/layout.php">
      <operation>
	 <search regex ="true" quote = "true">
             
    <![CDATA[~public function getLayoutModules($layout_id, $position) {
		$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "layout_module WHERE layout_id = '" . (int)$layout_id . "' AND position = '" . $this->db->escape($position) . "' ORDER BY sort_order");
		
		return $query->rows;
	}~]]>
         </search>
         <add position ="replace">
        <![CDATA[
        
             public function getLayoutModules($layout_id, $position) {
		   $query = $this->db->query("SELECT * FROM " . DB_PREFIX . "layout_module WHERE layout_id = '" . (int)$layout_id . "' AND position = '" . $this->db->escape($position) . "' ORDER BY sort_order");
		
		   return $query->rows;
	     }


             public function getLayoutForAllPages(){
                        $query = $this->db->query("SELECT * FROM " . DB_PREFIX . "layout WHERE name like '%all pages%' LIMIT 1");

                         if ($query->num_rows) {
                             return $query->row['layout_id'];
                         } else {
                              return 0;
                         }
                 }]]>
         </add>  
      </operation>
  </file>
   <file path="catalog/controller/common/footer.php">
      <operation>
	 <search>
         <![CDATA[$this->load->model('catalog/product');]]>
         </search>
         <add position ="after">
          <![CDATA[$data['modules'] = array();
                
                   $data['modules']['newslettersubscribe'] = $this->load->controller('module/newslettersubscribe');]]>
         </add>  
      </operation>
  </file>
  <file path="catalog/controller/common/footer.php">
      <operation>
	 <search>
         <![CDATA[$data['text_information'] = $this->language->get('text_information');]]>
         </search>
         <add position ="after">
         <![CDATA[if (is_file(DIR_IMAGE . $this->config->get('config_logo'))) {
			$data['logo'] = $server . 'image/' . $this->config->get('config_logo');
		} else {
			$data['logo'] = '';
		}
                
                $data['home'] = $this->url->link('common/home');
                $data['name'] = $this->config->get('config_name');]]>
         </add>  
      </operation>
  </file>
  </modification>
