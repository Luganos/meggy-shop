<?xml version="1.0" encoding="utf-8"?>
<modification>
  <name>Modification for bind option</name>
  <code>default</code>
  <version>1.0</version>
  <author>Lugano</author>
  <link>http://www.full-chip.com</link>
  <file path="admin/controller/catalog/product.php">
    <operation>
      <search>
        <![CDATA[$this->load->model('catalog/product');]]>
      </search>
      <add position="after">
        <![CDATA[$this->load->model('module/bind_option');]]>
      </add>
    </operation>
    <operation>
      <search>
        <![CDATA[protected function getForm() {]]>
      </search>
      <add position="after">
        <![CDATA[$data['base'] = '/admin/view/javascript/bind-option/bind_option.js';]]>
      </add>
    </operation>
    <operation>
      <search>
        <![CDATA[$this->model_catalog_product->editProduct($this->request->get['product_id'], $this->request->post);]]>
      </search>
      <add position="after">
        <![CDATA[$this->model_module_bind_option->addImageForColour($this->request->get['product_id'], $this->request->post);]]>
      </add>
    </operation>
    <operation>
      <search>
        <![CDATA[$data['entry_quantity'] = $this->language->get('entry_quantity');]]>
      </search>
      <add position="after">
        <![CDATA[$data['entry_bind_with'] = $this->language->get('entry_bind_with');]]>
      </add>
    </operation>
    <operation>
      <search regex ="true" quote = "true">
    <![CDATA[~foreach ($product_options as $product_option) {
			$product_option_value_data = array();

			if (isset($product_option['product_option_value'])) {
				foreach ($product_option['product_option_value'] as $product_option_value) {
					$product_option_value_data[] = array(
						'product_option_value_id' => $product_option_value['product_option_value_id'],
						'option_value_id'         => $product_option_value['option_value_id'],
						'quantity'                => $product_option_value['quantity'],
						'subtract'                => $product_option_value['subtract'],
						'price'                   => $product_option_value['price'],
						'price_prefix'            => $product_option_value['price_prefix'],
						'points'                  => $product_option_value['points'],
						'points_prefix'           => $product_option_value['points_prefix'],
						'weight'                  => $product_option_value['weight'],
						'weight_prefix'           => $product_option_value['weight_prefix']
					);
				}
			}

			$data['product_options'][] = array(
				'product_option_id'    => $product_option['product_option_id'],
				'product_option_value' => $product_option_value_data,
				'option_id'            => $product_option['option_id'],
				'name'                 => $product_option['name'],
				'type'                 => $product_option['type'],
				'value'                => isset($product_option['value']) ? $product_option['value'] : '',
				'required'             => $product_option['required']
			);
		}~]]>
      </search>
      <add position="replace">
      <![CDATA[	foreach ($product_options as $product_option) {
			$product_option_value_data = array();

			if (isset($product_option['product_option_value'])) {
				foreach ($product_option['product_option_value'] as $product_option_value) {
                                    
                                        $name = $this->model_catalog_product->getProductBySku($product_option_value['bind_with']);
                                        if (!empty($name['name']) && $name['name'] !== 0 && $name['name'] !== NULL) {
                                            
                                            $name_product = $name['name'];
                                        }  else {
                                             
                                           $name_product = NULL; 
                                        }
                                        
					$product_option_value_data[] = array(
						'product_option_value_id' => $product_option_value['product_option_value_id'],
						'option_value_id'         => $product_option_value['option_value_id'],
						'quantity'                => $product_option_value['quantity'],
						'subtract'                => $product_option_value['subtract'],
						'price'                   => $product_option_value['price'],
						'price_prefix'            => $product_option_value['price_prefix'],
						'points'                  => $product_option_value['points'],
						'points_prefix'           => $product_option_value['points_prefix'],
						'weight'                  => $product_option_value['weight'],
                                                'bind_name'               => (empty($name_product))? 'Нет связей': $name_product,
                                                'bind_id'                 => $product_option_value['bind_with'],
						'weight_prefix'           => $product_option_value['weight_prefix']
					);
				}
			}

			$data['product_options'][] = array(
				'product_option_id'    => $product_option['product_option_id'],
				'product_option_value' => $product_option_value_data,
				'option_id'            => $product_option['option_id'],
				'name'                 => $product_option['name'],
				'type'                 => $product_option['type'],
				'value'                => isset($product_option['value']) ? $product_option['value'] : '',
				'required'             => $product_option['required']
			);
		}]]>
      </add>
    </operation>
    <operation>
      <search regex ="true" quote = "true">
      <![CDATA[~if (isset($this->request->post['image']) && is_file(DIR_IMAGE . $this->request->post['image'])) {
			$data['thumb'] = $this->model_tool_image->resize($this->request->post['image'], 100, 100);
		} elseif (!empty($product_info) && is_file(DIR_IMAGE . $product_info['image'])) {
			$data['thumb'] = $this->model_tool_image->resize($product_info['image'], 100, 100);
		} else {
			$data['thumb'] = $this->model_tool_image->resize('no_image.png', 100, 100);
		}~]]>
      </search>
      <add position="replace">
        <![CDATA[
                if (isset($this->request->post['image']) && is_file(DIR_IMAGE . $this->request->post['image'])) {
			$data['thumb'] = $this->model_tool_image->resize($this->request->post['image'], 100, 100);
		} elseif (!empty($product_info) && is_file(DIR_IMAGE . $product_info['image'])) {
			$data['thumb'] = $this->model_tool_image->resize($product_info['image'], 100, 100);
		} else {
			$data['thumb'] = $this->model_tool_image->resize('no_image.png', 100, 100);
		}
        
        
        
                $image_for_colour = $this->model_module_bind_option->getProduct($this->request->get['product_id']);
                
                 if (empty($image_for_colour['image_for_bind'])) {
                     
                        $data['image_for_colour'] = $this->model_tool_image->resize('no_image.png', 100, 100);
                 } else {
                     
                     if (is_file(DIR_IMAGE . $image_for_colour['image_for_bind'])) {
                         
                        $data['image_for_colour'] = $this->model_tool_image->resize($image_for_colour['image_for_bind'], 100, 100); 
                     } else {
                         
                        $data['image_for_colour'] = $this->model_tool_image->resize('no_image.png', 100, 100);
                     }
                     
                     
                 }]]>
      </add>
    </operation>
  </file>
  <file path="admin/view/template/catalog/product_form.tpl">
   <operation>
      <search regex ="true" quote = "true">
<![CDATA[~<ul class="nav nav-tabs">
            <li class="active"><a href="#tab-general" data-toggle="tab"><?php echo $tab_general; ?></a></li>
            <li><a href="#tab-data" data-toggle="tab"><?php echo $tab_data; ?></a></li>
            <li><a href="#tab-links" data-toggle="tab"><?php echo $tab_links; ?></a></li>
            <li><a href="#tab-attribute" data-toggle="tab"><?php echo $tab_attribute; ?></a></li>
            <li><a href="#tab-option" data-toggle="tab"><?php echo $tab_option; ?></a></li>
            <li><a href="#tab-recurring" data-toggle="tab"><?php echo $tab_recurring; ?></a></li>
            <li><a href="#tab-discount" data-toggle="tab"><?php echo $tab_discount; ?></a></li>
            <li><a href="#tab-special" data-toggle="tab"><?php echo $tab_special; ?></a></li>
            <li><a href="#tab-image" data-toggle="tab"><?php echo $tab_image; ?></a></li>
            <li><a href="#tab-reward" data-toggle="tab"><?php echo $tab_reward; ?></a></li>
            <li><a href="#tab-design" data-toggle="tab"><?php echo $tab_design; ?></a></li>
          </ul>~]]>
      </search>
      <add position="replace">
<![CDATA[<ul class="nav nav-tabs">
            <li class="active"><a href="#tab-general" data-toggle="tab"><?php echo $tab_general; ?></a></li>
            <li><a href="#tab-data" data-toggle="tab"><?php echo $tab_data; ?></a></li>
            <li><a href="#tab-links" data-toggle="tab"><?php echo $tab_links; ?></a></li>
            <li><a href="#tab-attribute" data-toggle="tab"><?php echo $tab_attribute; ?></a></li>
            <li><a href="#tab-option" data-toggle="tab"><?php echo $tab_option; ?></a></li>
            <li><a href="#tab-recurring" data-toggle="tab"><?php echo $tab_recurring; ?></a></li>
            <li><a href="#tab-discount" data-toggle="tab"><?php echo $tab_discount; ?></a></li>
            <li><a href="#tab-special" data-toggle="tab"><?php echo $tab_special; ?></a></li>
            <li><a href="#tab-image" data-toggle="tab"><?php echo $tab_image; ?></a></li>
            <li><a href="#tab-reward" data-toggle="tab"><?php echo $tab_reward; ?></a></li>
            <li><a href="#tab-design" data-toggle="tab"><?php echo $tab_design; ?></a></li>
            <li><a href="#tab-relation" data-toggle="tab">Цвет продукта</a></li>
          </ul>]]>
      </add>
    </operation>  
    <operation>
      <search>
<![CDATA[<div class="tab-pane active" id="tab-general">]]>
      </search>
      <add position="before">
 <![CDATA[<div class="tab-pane" id="tab-relation">
                <table class="table table-striped table-bordered table-hover" style="margin-top: 10px;">
                    <tr id="image-row">
                      <td class="text-left col-sm-2"> Загрузите фото продукта :  </td>
                      <td class="text-left col-sm-6"><a href="" id="thumb-image-1-1" data-toggle="image" class="img-thumbnail"><img src="<?php echo $image_for_colour; ?>" alt="" title="" data-placeholder="<?php echo $image_for_colour; ?>" /></a><input type="hidden" name="image_for_colour[image]" value="<?php echo $image_for_colour['image']; ?>" id="input-image-1-1" class="form-control" /></td>
                    </tr> 
                </table>  
           </div>]]>
      </add>
    </operation>
    <operation>
      <search regex ="true" quote = "true" >
              <![CDATA[~<table id="option-value<?php echo $option_row; ?>" class="table table-striped table-bordered table-hover">
                          <thead>
                            <tr>
                              <td class="text-left"><?php echo $entry_option_value; ?></td>
                              <td class="text-right"><?php echo $entry_quantity; ?></td>
                              <td class="text-left"><?php echo $entry_subtract; ?></td>
                              <td class="text-right"><?php echo $entry_price; ?></td>
                              <td class="text-right"><?php echo $entry_option_points; ?></td>
                              <td class="text-right"><?php echo $entry_weight; ?></td>
                              <td></td>
                            </tr>
                          </thead>~]]>
      </search>
      <add position="replace">
               <![CDATA[<table id="option-value<?php echo $option_row; ?>" class="table table-striped table-bordered table-hover">
                          <thead>
                            <tr>
                              <td class="text-left"><?php echo $entry_option_value; ?></td>
                              <td class="text-right"><?php echo $entry_quantity; ?></td>
                              <td class="text-right"><?php echo $entry_bind_with; ?></td>
                              <td class="text-left"><?php echo $entry_subtract; ?></td>
                              <td class="text-right"><?php echo $entry_price; ?></td>
                              <td class="text-right"><?php echo $entry_option_points; ?></td>
                              <td class="text-right"><?php echo $entry_weight; ?></td>
                              <td></td>
                            </tr>
                          </thead>]]>
      </add>
    </operation> 
    <operation>
      <search>
      <![CDATA[<td class="text-right"><input type="text" name="product_option[<?php echo $option_row; ?>][product_option_value][<?php echo $option_value_row; ?>][quantity]" value="<?php echo $product_option_value['quantity']; ?>" placeholder="<?php echo $entry_quantity; ?>" class="form-control" /></td>]]>
      </search>
      <add position="after">
      <![CDATA[<td class="text-right">
                    <input id = "id-for-user-<?php echo $option_row; ?>-<?php echo $option_value_row; ?>" type="text" value="<?php echo $product_option_value['bind_name']; ?>" placeholder="<?php echo $entry_bind_with; ?>" class="form-control" name ="bind_option[<?php echo $option_row; ?>][<?php echo $option_value_row; ?>]" />
                    <input type="hidden" id = "id-for-server-<?php echo $option_row; ?>-<?php echo $option_value_row; ?>"  name="product_option[<?php echo $option_row; ?>][product_option_value][<?php echo $option_value_row; ?>][bind_id]" value="<?php echo $product_option_value['bind_id']; ?>" placeholder="<?php echo $entry_bind_with; ?>" class="form-control" />
      </td>]]>
      </add>
    </operation>  
    <operation>
      <search>
      <![CDATA[html += '        <td class="text-right"><?php echo $entry_quantity; ?></td>';]]>
      </search>
      <add position="after">
      <![CDATA[html += '        <td class="text-right"><?php echo $entry_bind_with; ?></td>';]]>
      </add>
    </operation>
    <operation>
      <search>
      <![CDATA[<?php echo $footer; ?>]]>
      </search>
      <add position="before">
      <![CDATA[<script src ="<?php echo $base; ?>"></script>]]>
      </add>
    </operation>
    <operation>
      <search>
      <![CDATA[html += '  <td class="text-right"><input type="text" name="product_option[' + option_row + '][product_option_value][' + option_value_row + '][quantity]" value="" placeholder="<?php echo $entry_quantity; ?>" class="form-control" /></td>';]]>
      </search>
      <add position="after">
      <![CDATA[
       html += '<td class="text-right">';
       html += '    <input id = "id-for-user-'+option_row+'-'+option_value_row+'" type="text" value="Нет связей" placeholder="<?php echo $entry_bind_with; ?>" class="form-control" name ="bind_option[' + option_row + '][' + option_value_row + ']" />';
       html += '    <input type="hidden" id = "id-for-server-'+option_row+'-'+option_value_row+'"  name="product_option[' + option_row + '][product_option_value][' + option_value_row + '][bind_id]" value="0" placeholder="<?php echo $entry_bind_with; ?>" class="form-control" />';
       html += '</td>';]]>
      </add>
    </operation>    
  </file>
  <file path="admin/language/russian/catalog/product.php">
    <operation>
      <search>
        <![CDATA[$_['entry_quantity']         = 'Количество';]]>
      </search>
      <add position="after">
        <![CDATA[$_['entry_bind_with']         = 'Связать с';]]>
      </add>
    </operation>
  </file>   
  <file path="admin/model/catalog/product.php">
    <operation>
      <search>
        <![CDATA['weight'                  => $product_option_value['weight'],]]>
      </search>
      <add position="after">
        <![CDATA['bind_with'               => (empty($product_option_value['bind_product_id']))? 0 : $product_option_value['bind_product_id'],]]>
      </add>
    </operation>
    <operation>
      <search>
        <![CDATA[$this->db->query("DELETE FROM " . DB_PREFIX . "product WHERE product_id = '" . (int)$product_id . "'");]]>
      </search>
      <add position="after">
        <![CDATA[$this->db->query("DELETE FROM " . DB_PREFIX . "product_to_bind_image WHERE product_id = " . (int)$product_id);]]>
      </add>
    </operation>
    <operation>
      <search>
        <![CDATA[$this->db->query("INSERT INTO " . DB_PREFIX . "product_option_value SET product_option_value_id = '" . (int)$product_option_value['product_option_value_id'] . "', product_option_id = '" . (int)$product_option_id . "', product_id = '" . (int)$product_id . "', option_id = '" . (int)$product_option['option_id'] . "', option_value_id = '" . (int)$product_option_value['option_value_id'] . "', quantity = '" . (int)$product_option_value['quantity'] . "', subtract = '" . (int)$product_option_value['subtract'] . "', price = '" . (float)$product_option_value['price'] . "', price_prefix = '" . $this->db->escape($product_option_value['price_prefix']) . "', points = '" . (int)$product_option_value['points'] . "', points_prefix = '" . $this->db->escape($product_option_value['points_prefix']) . "', weight = '" . (float)$product_option_value['weight'] . "', weight_prefix = '" . $this->db->escape($product_option_value['weight_prefix']) . "'");]]>
      </search>
      <add position="replace">
        <![CDATA[$this->db->query("INSERT INTO " . DB_PREFIX . "product_option_value SET product_option_value_id = '" . (int)$product_option_value['product_option_value_id'] . "', product_option_id = '" . (int)$product_option_id . "', product_id = '" . (int)$product_id . "', option_id = '" . (int)$product_option['option_id'] . "', option_value_id = '" . (int)$product_option_value['option_value_id'] . "', quantity = '" . (int)$product_option_value['quantity'] . "', subtract = '" . (int)$product_option_value['subtract'] . "', price = '" . (float)$product_option_value['price'] . "', price_prefix = '" . $this->db->escape($product_option_value['price_prefix']) . "', points = '" . (int)$product_option_value['points'] . "', points_prefix = '" . $this->db->escape($product_option_value['points_prefix']) . "', weight = '" . (float)$product_option_value['weight'] . "', weight_prefix = '" . $this->db->escape($product_option_value['weight_prefix']) . "', bind_product_id = '" . (int)$product_option_value['bind_id'] . "'");]]>
      </add>
    </operation>
    <operation>
      <search regex ="true" quote = "true">
  <![CDATA[~public function getTotalProductsByLayoutId($layout_id) {
		$query = $this->db->query("SELECT COUNT(*) AS total FROM " . DB_PREFIX . "product_to_layout WHERE layout_id = '" . (int)$layout_id . "'");

		return $query->row['total'];
	}~]]>
      </search>
      <add position="after">
        <![CDATA[public function getProductBySku($sku) {
            
                        $query = $this->db->query("SELECT * FROM `" . DB_PREFIX . "product` p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) WHERE sku = '" . $this->db->escape($sku) . "'");
                        return $query->row;
                 }]]>
      </add>
    </operation>
  </file>   
</modification>







